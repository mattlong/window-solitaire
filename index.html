<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Window</title>

    <meta name="author" content="Jonathan Matt Long">
    <meta name="description" content="Personal homepage including a blog, interesting links, musical tastes, and my personal beer cellar">
    <meta name="keywords" content="Matt Long,blog,software,technology">
    <!--link rel="shortcut icon" href="/static/favicon.ico" type="image/vnd.microsoft.icon"-->

    <!--link rel='stylesheet' href='//fonts.googleapis.com/css?family=FONT1|FONT2ETC' type='text/css'-->
    <link rel="stylesheet" href="normalize.css">
    <style>
        * { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

        #Table { position:relative; margin-top:10px; width:960px; }

        .unselectable { -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .card, .spot { border:1px solid black; width:50px; height:70px; padding-top:10px; text-align:center;}
        .card { position:absolute; top:-1px; left:-1px; }
        .spot { position:relative; float:left; }

        .card.clearable { background-color: red; }
        .card.selected { background-color: green; }

        #LeftPanel { position:relative; float:left; width:120px; height:322px; }

        #NextCard { position:absolute; top:100px; left:30px; }
        #NewGame { position:absolute; left:10px; bottom:20px; }

        #Grid { float:left; border:1px solid black; width:242px; height:322px; }
        #Grid .spot { margin:5px; }

    </style>
</head>
<body>
    <div id="Table">

        <div id="LeftPanel">
            <div id="NextCard" class="spot"></div>
            <button id="NewGame">New Game</button>
        </div>

        <div id="Grid">
            <div id="00" class="spot"></div>
            <div id="01" class="spot"></div>
            <div id="02" class="spot"></div>
            <div id="03" class="spot"></div>
            <div id="10" class="spot"></div>
            <div id="11" class="spot"></div>
            <div id="12" class="spot"></div>
            <div id="13" class="spot"></div>
            <div id="20" class="spot"></div>
            <div id="21" class="spot"></div>
            <div id="22" class="spot"></div>
            <div id="23" class="spot"></div>
            <div id="30" class="spot"></div>
            <div id="31" class="spot"></div>
            <div id="32" class="spot"></div>
            <div id="33" class="spot"></div>
        </div> 
    </div>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="libraries/jquery-1.8.3.min.js"><\/script>')</script>

    <!--script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.3/underscore-min.js"></script-->
    <script>window._ || document.write('<script src="libraries/underscore-1.4.3.min.js"><\/script>')</script>

    <!--script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.9/backbone-min.js"></script-->
    <script>window.Backbone || document.write('<script src="libraries/backbone-0.9.9.min.js"><\/script>')</script>

    <script>
        String.prototype.format = function(obj) {
            var formatted = this, offset = 0;
            if (typeof(obj) === 'object') {
                offset = 1;
                for (var key in obj) {
                    var regexp = new RegExp('\\{'+key+'\\}', 'gi');
                    formatted = formatted.replace(regexp, obj[key]);
                }
            }
            for (var i = 0; i < arguments.length - offset; i++) {
                var regexp = new RegExp('\\{'+i+'\\}', 'gi');
                formatted = formatted.replace(regexp, arguments[i+offset]);
            }
            return formatted.toString();
        };
    </script>
    <script src="cards.js"></script>
    <script>

        var WindowCardView = CardView.extend({
            moreEvents: {
                    "click": "onClick"
            },

            initialize: function() {
                this.events = _.extend({}, this.events, this.moreEvents);
                this.delegateEvents();
            },

            points: function() {
                var rank = this.model.get("rank");
                if (parseInt(rank))
                    return parseInt(rank);
                else if (rank == "A")
                    return 1;
                else
                    return null;
            },

            toggleClearable: function(isClearable) {
                this.$el.toggleClass("clearable", isClearable);
            },

            select: function() {
                this.$el.toggleClass("selected", true);
            },

            unselect: function() {
                this.$el.toggleClass("selected", false);
            },

            onClick: function() {
                if (!this.$el.is(".clearable")) return;

                Backbone.trigger("card-selected", this, this.model.get("rank"));
            },

            clear: function() {
                var coords = this.$el.parents(".spot").attr("id");
                var loc = _.map(coords.split(""), function(num){return parseInt(num)});

                this.remove();
                Backbone.trigger("card-cleared", this, loc[0], loc[1]);
            }
        });

        var WindowBoard = Backbone.View.extend({
            el: $('#Table'),

            events: {
                "click #Grid .spot": "placeCard",
                "click #NewGame": "newGame",
            },

            initialize: function() {
                this.listenTo(Backbone, "card-selected",  this.cardSelected);
                this.listenTo(Backbone, "card-cleared",  this.cardCleared);

                this.deck = null;

                this.emptySpots = 16;

                this.grid = [[], [], [], []];
                this.gridEl = $("#Grid");

                this.nextCard = null;
                this.nextCardEl = $("#NextCard");

                this.newGame();
            },

            render: function() {

            },

            newGame: function() {
                if (this.deck) this.stopListening(this.deck);
                this.deck = Stack.createDeck();

                for (var r = 0; r < 4; r++)
                    for (var c = 0; c < 4; c++) {
                        var cardView = this.grid[r][c];
                        if (cardView) cardView.clear();
                        this.grid[r][c] = null;
                }

                this.dealNextCard();
            },

            dealNextCard: function() {
                this.nextCard = this.deck.deal();
                this.nextCard = new WindowCardView({model: this.nextCard});
                this.nextCardEl.html(this.nextCard.render().el);

                // game over?
                var card = this.nextCard.model;
                var rank = card.get("rank");
                var g = this.grid;
                switch (rank) {
                    case "J": // jacks
                        if (g[1][0] && g[1][3] && g[2][0] && g[2][3]) return this.gameOver();
                        break;
                    case "Q": // queens
                        if (g[0][1] && g[0][2] && g[3][1] && g[3][2]) return this.gameOver();
                        break;
                    case "K": // kings
                        if (g[0][0] && g[0][3] && g[3][0] && g[3][3]) return this.gameOver();
                        break;
                }
            },

            placeCard: function(e) {
                // card to play?
                if (!this.nextCard) return;

                var spot = $(e.currentTarget);
                var coords = spot.attr("id");
                var loc = _.map(coords.split(""), function(num){return parseInt(num)});
                var g = this.grid;

                // is spot taken?
                if (g[loc[0]][loc[1]]) return;

                // validate play
                var card = this.nextCard.model;
                var rank = card.get("rank");
                switch (rank) {
                    case "J": // jacks
                        if (!_.contains(["10", "13", "20", "23"], coords)) return;
                        break;
                    case "Q": // queens
                        if (!_.contains(["01", "02", "31", "32"], coords)) return;
                        break;
                    case "K": // kings
                        if (!_.contains(["00", "03", "30", "33"], coords)) return;
                        break;
                }

                // actually place the card
                this.emptySpots--;
                this.nextCard.$el.appendTo(spot);

                g[loc[0]][loc[1]] = this.nextCard;
                this.nextCard = null;

                // win?
                var jacks = _.every([g[1][0], g[1][3], g[2][0], g[2][3]], function(spot) {
                    return spot && spot.model.get("rank") == "J";
                });
                var queens = _.every([g[0][1], g[0][2], g[3][1], g[3][2]], function(spot) {
                    return spot && spot.model.get("rank") == "Q";
                });
                var kings = _.every([g[0][0], g[0][3], g[3][0], g[3][3]], function(spot) {
                    return spot && spot.model.get("rank") == "K";
                });

                if (jacks && queens && kings) return win();

                // the game goes on...
                if (this.emptySpots == 0)
                    this.clearTens();
                else
                    this.dealNextCard();
            },

            clearTens: function() {
                // mark clearable. if none, game over
                if (this.markClearableCards() == 0) return gameOver();
            },

            markClearableCards: function() {

                var present = {0:true};
                var toMark = {};
                _.each(_.flatten(this.grid), function(cardView) {
                    var points = cardView && cardView.points();

                    if (!points) return;

                    if (present[10-points]) {
                        toMark[points] = true;
                        toMark[10-points] = true;
                    } else {
                        present[points] = true;
                    }
                });

                var count = 0;
                _.each(_.flatten(this.grid), function(cardView) {
                    var points = cardView && cardView.points()
                    if (!points) return;

                    if (toMark[points]) {
                        cardView.toggleClearable(true);
                        count++;
                    } else {
                        cardView.toggleClearable(false);
                    }
                });

                return count;
            },

            cardSelected: function(cardView, rank) {
                var points = cardView.points();

                if (!this.selectedCard) {
                    // no other card selected, select this one
                    if (points == 10) { //clear it immediately
                        cardView.clear();                        
                    } else {
                        this.selectedCard = cardView;
                        this.selectedCard.select();
                    }
                } else if (this.selectedCard == cardView) { 
                    // this was already selected, unselect it
                    this.selectedCard.unselect();
                    this.selectedCard = null;
                } else {
                    console.warn(points);
                    //make sure other selected card sums to 10
                    var otherPoints = this.selectedCard.points();
                    console.warn(points, otherPoints, points + otherPoints, points + otherPoints == 10);
                    if (points + otherPoints == 10) {
                        cardView.clear();
                        this.selectedCard.clear();
                        this.selectedCard = null;
                    }
                }

                if (this.markClearableCards() == 0) this.dealNextCard();
            },

            cardCleared: function(cardView, row, col) {
                this.grid[row][col] = null;
                this.emptySpots++;
            },

            win: function() {
                alert("you win :)");
            },

            gameOver: function() {
                alert("game over :(");
            }
        });

        var table = new WindowBoard();
    </script>
  </body>
</html>
